# 对象池项目分享

## 语言方面

### 命名

- 对于多项测试可以合并使用宏，避免堆砌大量重复代码，宏名要能够精炼的描述宏的用途。

- 如果没有合适的描述，可以使用 `DEFINE TEST` 来表示自定义的一个测试。

- 确保宏定义中的参数名称不与外部变量或函数名冲突，避免无效声明和意外的行为。

```C++
TEST_F(ObjectPoolTest, All) {
#define DEFINE_TEST(size, a_counter)  \
  do {                                \
    EXPECT_EQ(pool.size(), size);     \
    EXPECT_EQ(A::counter, a_counter); \
  } while (0)

  ObjectPool<A> pool;

  pool.init(3);
  DEFINE_TEST(3u, 3u);
  //...
}
```

```bash
error: expected unqualified-id
```

```C++
#define DEFINE_TEST(pool_size, a_counter)
```

#### error: expected unqualified-id

- Omitted or Misplaced Semicolons
- Writing Strings without Quotes
- Header Files Not Included
- Invalid Variable Declaration
- Under or Over-usage of Braces

<https://www.geeksforgeeks.org/expected-unqualified-id-error-in-cpp/>

#### STL 风格的类型命名规则

- 对于实现基础库或工具类程序，定义类型时可以使用类似 STL 的命名方式，全小写 + 下划线。

  - 使用 `smart_pointer` 保持对原有版本的兼容性。

  - 使用 `shared_pointer` 后续对原有版本的扩展。

```C++
using smart_pointer = std::unique_ptr<value_type, deleter_type>;
using shared_pointer = std::shared_ptr<value_type>;
```

### DRY 原则

- Don’t Repeat Yourself.

- 不要总是用相同代码解决相同问题。

- 提高代码的可维护性，减少错误。

- 所有的改变只需要在一个地方修改，提高了代码的可读性和可扩展性。

```C++
template <typename T>
bool object_pool<T>::init(size_t max_size) {
  return init(max_size, []() { return new value_type(); });
}

template <typename T>
bool object_pool<T>::init(size_t max_size, const creator_type& creator, const deleter_type& deleter) {
  //...
}
```

### 作用域

- 保证超出测试单元后及时释放资源。

```C++
/* ObjectPoolTest 类的所有测试单元结束后释放 */
class ObjectPoolTest : public testing::Test{
 protected:
  ObjectPool<A> pool;

 protected:
  void TearDown() override { EXPECT_EQ(A::counter, 0u); }
};

/* TEST_F 结束后释放 */
TEST_F(ObjectPoolTest, All){
  ObjectPool<A> pool;
  //...
}
```

## Makefile

```C++
template <typename T>
size_t ObjectPool<T>::size() const {
  return pool_.size();
}

TEST_F(ObjectPoolTest, All) {
#define DEFINE_TEST(pool_size, a_counter) \
  do {                                    \
    EXPECT_EQ(pool.size(), pool_size);    \
    EXPECT_EQ(A::counter, a_counter);     \
  } while (0)

  ObjectPool<A> pool;

  pool.init(3);
  DEFINE_TEST(3, 3);
  //...
}
```

```bash
error: comparison between signed and unsigned integer expressions [-Werror=sign-compare]
```

```C++
TEST_F(ObjectPoolTest, All) {
#define DEFINE_TEST(pool_size, a_counter)         \
  do {                                            \
    EXPECT_EQ(pool.size(), (size_t)pool_size);    \
    EXPECT_EQ(A::counter, (size_t)a_counter);     \
  } while (0)
  //...
}
```

## 心得体会

- 要先配置好工作环境再开始工作。

- 应该认真阅读文档，避免低级错误。

- 遵守代码规范，可以规避错误，并且看起来很美观。

- 要善于使用现成的工具，手敲命令易错且麻烦。

- 要及时整理笔记回顾问题，笔记要精炼且能看懂和解释。
