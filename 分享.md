# 对象池项目分享

## 语言

### 命名

- 对于多项测试可以合并使用宏，避免堆砌大量重复代码，宏名要能够精炼的描述宏的用途。

- 如果没有合适的描述，可以使用 `DEFINE TEST` 来表示自定义的一个测试。

```C++
#define TEST_OBJECT_POOL(size, construct_count, destruct_count)
```

- 宏参数名要注意不要操成冲突。

```C++
TEST_F(ObjectPoolTest, All) {
#define DEFINE_TEST(size, a_counter)  \
  do {                                \
    EXPECT_EQ(pool.size(), size);     \
    EXPECT_EQ(A::counter, a_counter); \
  } while (0)

  ObjectPool<A> pool;

  pool.init(3);           DEFINE_TEST(3u, 3u);
  pool.init(2);           DEFINE_TEST(2u, 2u);
  pool.init(4);           DEFINE_TEST(4u, 4u);
  //...
}
```

> error: expected unqualified-id

```C++
#define DEFINE_TEST(pool_size, a_counter)
```

#### error: expected unqualified-id

1. Omitted or Misplaced Semicolons
2. Writing Strings without Quotes
3. Header Files Not Included
4. Invalid Variable Declaration
5. Under or Over-usage of Braces

<https://www.geeksforgeeks.org/expected-unqualified-id-error-in-cpp/>

### 作用域

在测试所用的单元内进行声明，避免作用域问题。

保证超出测试单元后及时释放资源。

```C++
/* ObjectPoolTest 类的所有测试单元结束后释放 */
class ObjectPoolTest : public testing::Test{
 protected:
  ObjectPool<A> pool;
  //...
};

/* TEST_F 结束后释放 */
TEST_F(ObjectPoolTest, All){
  ObjectPool<A> pool;
  //...
}
```

## Makefile

```C++
template <typename T>
size_t ObjectPool<T>::size() const {
  return pool_.size();
}

TEST_F(ObjectPoolTest, All) {
#define DEFINE_TEST(pool_size, a_counter) \
  do {                                    \
    EXPECT_EQ(pool.size(), pool_size);    \
    EXPECT_EQ(A::counter, a_counter);     \
  } while (0)

  ObjectPool<A> pool;

  pool.init(3);              DEFINE_TEST(3, 3);
  pool.init(2);              DEFINE_TEST(2, 2);
  pool.init(4);              DEFINE_TEST(4, 4);
  //...
}
```

```bash
error: comparison between signed and unsigned integer expressions [-Werror=sign-compare]
```

```C++
TEST_F(ObjectPoolTest, All) {
#define DEFINE_TEST(pool_size, a_counter)         \
  do {                                            \
    EXPECT_EQ(pool.size(), (size_t)pool_size);    \
    EXPECT_EQ(A::counter, (size_t)a_counter);     \
  } while (0)
  //...
}
```

## 心得体会

- 要先配置好工作环境再开始工作。

- 应该认真再认真阅读文档，避免低级错误。

- 遵守代码规范，可以规避错误，并且看起来很美观。

- 要善于使用现成的工具，手敲命令易错且麻烦。

- 要及时整理笔记回顾问题，笔记要精炼且能看懂和解释。
